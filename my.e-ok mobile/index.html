<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>my.e-ok</title>
    <link href="themes/reset.css" rel="stylesheet" />
    <link href="themes/style.css" rel="stylesheet" />
    <link href="themes/jquery.mobile-1.4.3.min.css" rel="stylesheet" />
    <script src="scripts/jquery-1.10.2.min.js"></script>
    <script src="scripts/jquery.mobile-1.4.3.min.js"></script>
</head>
<body class="ui-mobile-viewport ui-overlay-c">
    <div data-role="page" id="login" data-theme="a">
        <div data-role="content" class="ui-content" role="main">
            <div class="melding" onclick="hideMelding()">
            </div>
            <div class="headerLogo">
                <img src="images/my.e-ok_Logo.png" />
            </div>
            <div id="containerLogin">
                <input type="email" id="loginInput" placeholder="Login" />
                <input type="password" id="paswoordInput" placeholder="Paswoord" />
                <input type="button" id="inloggen" class="btnInloggen" value="Inloggen" data-role="button" />
            </div>
            <div id="containerLoading">
                <img src="images/gif-load.gif" />
            </div>
        </div>
    </div>
    <div data-role="footer">
        <img src="images/logo-okc.png" />
    </div>
    <script src="scripts/DatabaseConnection.js"></script>
    <script src="cordova.js"></script>
    <script>
        var APIVersion = '2';

        document.addEventListener("backbutton", backButtonDown, false);
        function backButtonDown() {
            e.preventDefault();
            navigator.app.exitApp();
        }

        var timeout;
        // Als de pagina geladen is kijken of er een 'cookie' is opgeslaan met een eerder ingelogde gebruikerId
        // Indien wel --> login overslaan en met gegevens van vorige gebruiker blijven werken
        $(document).ready(function () {
            var mdwID = window.localStorage.getItem("mdwID");

            if (mdwID != null) {
                $.ajax({
                    headers: { 'Access-Control-Allow-Origin': "*" },
                    url: url + 'api/User/getVersionInfo/?apiVersion=' + APIVersion,
                    cache: false,
                    type: 'GET',
                    contentType: 'application/json; charset=utf-8',
                    success: function (data) {
                        window.localStorage.setItem("mdwID", mdwID);
                        window.location.href = "./home.html#home";
                    },
                    error: function (e) {
                        if (e.responseJSON == undefined || e.responseJSON == null)
                            melding("U heeft geen internet connectie.", 3000, 'error');
                        else
                            melding(e.responseJSON, 3000, 'error');
                    }
                });
            }
        });

        // Als een textveld focus krijgt het logog van okc verbergen (geeft problemen met het soft keyboard)
        $('#loginInput, #paswoordInput').focus(function () {
            $('[data-role=footer]').css("display", "none");
        });

        // Een melding aan de gebruiker meegeven
        // Bericht = tekst in de melding
        // fadeDelay = tijd dat het bericht zichtbaar is
        // status = wat voor soort melding is het? error (rood), warning (geel), success (groen)
        function melding(bericht, fadeDelay, status) {
            switch (status) {
                case "error":
                    $('.melding').css('background-color', '#ff5757');
                    break;
                case "warning":
                    $('.melding').css('background-color', '#ffdd57');
                    break;
                case "success":
                    $('.melding').css('background-color', '#57dd57');
                    break;
            }
            $('.melding').text(bericht);
            $('.melding').fadeIn();
            window.clearTimeout(timeout);
            timeout = setTimeout(function () { $('.melding').fadeOut(); }, fadeDelay);
        }

        // Melding verbergen wanneer er op geklikt wordt
        function hideMelding() {
            clearTimeout(timeout);
            $('.melding').fadeOut();
        }

        $("#inloggen").on('click', function () {
            if ($('[data-role=footer]')[0].style.display == 'none') {
                $('#containerLogin').css('display', 'none');
                $('#containerLoading').css('display', 'block');
                login();
            } else
                $('#loginInput').focus();
        });

        function login() {
            console.log('login');
            var user = {
                UserName: $("#loginInput").val(),
                Paswoord: $("#paswoordInput").val(),
                MedewerkerID: 0, Role: ''
            };

            $.ajax({
                headers: { 'Access-Control-Allow-Origin': "*" },
                url: url + 'api/user/Login/?apiVersion=' + APIVersion,
                cache: false,
                type: 'POST',
                contentType: 'application/json; charset=utf-8',
                data: JSON.stringify(user),
                success: function (data) {
                    window.localStorage.setItem("miRol", data.split('@#@')[1])
                    window.localStorage.setItem("mdwID", data.split('@#@')[0]);
                    window.location.href = "./home.html#home";
                },
                error: function (e) {
                    $('#containerLogin').css('display', 'block');
                    $('#containerLoading').css('display', 'none');
                    if (e.responseJSON == undefined || e.responseJSON == null)
                        melding("U heeft geen internet connectie.", 3000, 'error');
                    else
                        melding(e.responseJSON, 3000, 'error');
                }
            });
        }
    </script>
</body>
</html>