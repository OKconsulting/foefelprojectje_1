USE [eOKSQL-1]
GO
/****** Object:  StoredProcedure [dbo].[time_berekenMaandtotalen]    Script Date: 20/01/2015 9:52:12 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		Morten Minne
-- Create date: 25/09/2014
-- Description:	Dagelijks de maandtotalen berekenen van time.e-ok
-- =============================================
ALTER PROCEDURE [dbo].[time_berekenMaandtotalen]

AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
	declare @startTijd datetime = DATEADD(day, -1, getdate()),
	@aantalMdws int = cast((select count(mdwID) from [tblUserToegang] where typelogin = 'timeeok') as int)
	declare @datumGisteren datetime = dateadd(hour, -3, getdate())

	--alle mdws ophalen die toegang hebben tot time.e-ok
	declare @mdwsMetToegang table (mdwID int, rowNr int)
	INSERT INTO @mdwsMetToegang select mdwID, ROW_NUMBER() OVER (ORDER BY mdwID) as rowNr FROM [tblUserToegang] where typelogin = 'timeeok'
	while @aantalMdws != 0
	begin
		declare @totSec bigint = 0,
		@iItems int = 1,
		@totSecDone bit = 0,
		@mdwID int = cast((select mdwID from @mdwsMetToegang where rowNr = @aantalMdws) as int)
		declare @orgID int = cast((select orgID from [tblOrganisatieMedewerker] where mdwID = @mdwID) as int),
		@maand nvarchar(max) = cast(datepart(month, @startTijd) as nvarchar(max)),
		@jaar nvarchar(max) = cast(datepart(year, @startTijd) as nvarchar(max))
		declare @datumTConfig datetime = cast((@jaar + '-' + @maand + '-01 00:00:00.000') as datetime)
		declare @situatieStat int = cast((select top 1 situatieStatistieken from [time_tblOrgConfig] where orgID = @orgID and tijdstempel <= @datumTConfig and deactivated != 1 order by tijdstempel desc) as int)

		if ((select mdwInDienst from [tblMedewerker] where mdwID = @mdwID) <= @startTijd and (select count(*) from [tbltijdlog] where mdwID = @mdwID) > 0)
		begin
			declare @tikkingen table (tijdstempel datetime, sType varchar(max), rowNr int)
			declare @uurRoostersMdw table (uraID int, naam varchar(max), uraNaam varchar(max), uurrooster varchar(max), datumLaatsteAanpassing datetime, datumstart datetime, mdwID int, beginuurVM varchar(max), einduurVM varchar(max), beginuurNM varchar(max), einduurNM varchar(max), datumWijziging datetime, uurPerDag varchar(max))

			delete from @uurRoostersMdw
			insert into @uurRoostersMdw exec [getOverzichtUurroosterMedewerker] @mdwID = @mdwID, @startdatum = @startTijd, @einddatum = @startTijd
			delete from @tikkingen
			insert into @tikkingen SELECT tijdstempel, type, ROW_NUMBER() OVER (ORDER BY tijdstempel) as rowNr FROM [tblTijdLog] where CONVERT(VARCHAR(10),tijdstempel,111) = CONVERT(VARCHAR(10),@startTijd ,111) and mdwID = @mdwID

			-- Contolleren of de mdw niet vergeten is te tikken
			declare @vergetenTikken bit = 0
			if (select count(*) from @tikkingen) != 0 and (select sType from @tikkingen where rowNr = (select count(*) from @tikkingen)) = 'START'
				set @vergetenTikken = 1

			-- Indien de mdw vergat te tikken voeren we de berekening niet uit
			if @vergetenTikken = 0
			begin
				-- De tijdlogs afronden
				declare @uurroosterID int = cast((select top 1 uraID from @uurRoostersMdw where datumstart <= @datumGisteren) as int)
				if @uurroosterID is not null and @uurroosterID != ''
				begin
					declare @afronden bigint,
					@uraSituatie int = cast((select top 1 normaalID from [tblSituatieUurroosterAlgemeen] where uraID = @uurroosterID order by tijdstempel desc) as int)
					if @uraSituatie is null or @uraSituatie = ''
					begin
						set @uraSituatie = cast((select top 1 glijdendID from [tblSituatieUurroosterAlgemeen] where uraID = @uurroosterID order by tijdstempel desc) as int)
						if @uraSituatie is null or @uraSituatie = ''
							set @uraSituatie = cast((select top 1 flexibelID from [tblSituatieUurroosterAlgemeen] where uraID = @uurroosterID order by tijdstempel desc) as int)
							if @uraSituatie is null or @uraSituatie != ''
								set @afronden = cast((select afronden from [tblSituatieFlexibel] where flexibelID = @uraSituatie) as int)
						else
							set @afronden = cast((select afronden from [tblSituatieGlijdend] where glijdendID = @uraSituatie) as int)
					end
					else
						set @afronden = cast((select afronden from [tblSituatieNormaal] where normaalID = @uraSituatie) as int)
		
					-- Hoeveelheid afronden is bekend --> effectief afronden
					set @afronden = @afronden * 600000000
					if @afronden != 0 and @afronden != 60000000
					begin
						declare @aantal int = cast((select count(*) from @tikkingen) as int)
						while @aantal != 0
						begin
							declare @ticks bigint,
							@seconden bigint = DatePart(Second, cast((select tijdstempel from @tikkingen where rowNr = @aantal) as datetime)),
							@minuten bigint = DatePart(minute, cast((select tijdstempel from @tikkingen where rowNr = @aantal) as datetime)),
							@uren bigint = DatePart(hour, cast((select tijdstempel from @tikkingen where rowNr = @aantal) as datetime))
							set @ticks = @uren * 36000000000 + @minuten * 600000000 + @seconden * 10000000

							if cast((select sType from @tikkingen where rowNr = @aantal) as varchar(max)) = 'START'
								set @ticks = ((@ticks + @afronden - 1) / @afronden) * @afronden
							else
								set @ticks = (@ticks / @afronden) * @afronden

							set @uren = @ticks / 36000000000
							set @minuten = (@ticks - @uren * 36000000000) / 600000000
							set @seconden = ((@ticks - @uren * 36000000000) - (@minuten * 600000000)) / 10000000

							declare @newDate datetime = cast((cast(DatePart(year, @startTijd) as nvarchar(max)) + '-' + cast(DatePart(month, @startTijd) as nvarchar(max)) + '-' + cast(DatePart(day, @startTijd) as nvarchar(max)) + ' ' + cast(@uren as nvarchar(max)) + ':' + cast(@minuten as nvarchar(max)) + ':' + cast(@seconden as nvarchar(max)) + '.000') as datetime)
							UPDATE @tikkingen SET tijdstempel = @newDate WHERE rowNr = @aantal

							set @aantal = @aantal - 1
						end
					end
				end

				--Het aantal gewerkte uren ophalen van de werknemen
				while @totSecDone = 0
				begin
					declare @start datetime = CAST((select tijdstempel from @tikkingen where rowNr = @iItems) as datetime)
					declare @stop datetime = CAST((select tijdstempel from @tikkingen where rowNr = (@iItems + 1)) as datetime)

					if @stop is null or @stop = '' or @start is null or @start = ''
						set @totSecDone = 1
					else
						if(@start < @stop)
							set @totSec = @totSec + DATEDIFF(second, @start, @stop)
		
					set @iItems = @iItems + 2
				end
				set @totSec = @totSec * 10000000		

				--Ophalen van de regel die van toepassing is
				declare @datumRegel datetime = @datumGisteren,
				@datumSet bit = 0
				if datepart(dw, @datumGisteren) = 2 and @datumSet = 0
				begin
					set @datumRegel = DATEADD(day, 6, @datumGisteren)
					set @datumSet = 1
				end
				if datepart(dw, @datumGisteren) = 3 and @datumSet = 0
				begin
					set @datumRegel = DATEADD(day, 5, @datumGisteren)
					set @datumSet = 1
				end
				if datepart(dw, @datumGisteren) = 4 and @datumSet = 0
				begin
					set @datumRegel = DATEADD(day, 4, @datumGisteren)
					set @datumSet = 1
				end
				if datepart(dw, @datumGisteren) = 5 and @datumSet = 0
				begin
					set @datumRegel = DATEADD(day, 3, @datumGisteren)
					set @datumSet = 1
				end
				if datepart(dw, @datumGisteren) = 6 and @datumSet = 0
				begin
					set @datumRegel = DATEADD(day, 2, @datumGisteren)
					set @datumSet = 1
				end
				if datepart(dw, @datumGisteren) = 7 and @datumSet = 0
				begin
					set @datumRegel = DATEADD(day, 1, @datumGisteren)
					set @datumSet = 1
				end

				declare @overuurID int = cast((select top 1 overuurID from [tblSituatieOveruurMedewerker] where mdwID = @mdwID and deactivated != 1 and toepassenVanaf <= @datumRegel order by tijdstempel desc) as int),
				@childRegelID int

				if @overuurID is not null and @overuurID != ''
					set @childRegelID = cast((SELECT top 1 overuurID FROM [tblSituatieOveruur] where parentRegel = @overuurID and tijdstempel <= @datumRegel order by tijdstempel desc) as int)
				declare @tblRegel table (maxPerDag int, maxPerWeek int, maxPerMaand int, maxPerDrieMaand int, maxPerZesMaand int, maxPerJaar int, overnemen bit, MinimumOverwerken int)
				declare @tblTotalen table (iWeek bigint, iMaand bigint, iDrieMaand bigint, iZesMaand bigint, iJaar bigint, iOngl bigint, overgenomen bit, iWeekNeg bigint, iMaandneg bigint, iDrieMaandNeg bigint, iZesMaandNeg bigint, iJaarNeg bigint)

				if @childRegelID is not null or @childRegelID != ''
					set @overuurID = @childRegelID
	
				delete from @tblRegel
				if @overuurID is not null and @overuurID != ''
					insert into @tblRegel SELECT maxPerDag, maxPerWeek, maxPerMaand, maxPerDrieMaand, maxPerZesMaand, maxPerJaar, prestOvernemen, MinimumOverwerken FROM [tblSituatieOveruur] where overuurID = @overuurID
				else
				begin
					insert into @tblRegel (maxPerWeek, maxPerMaand, maxPerDrieMaand, maxPerZesMaand, maxPerJaar, overnemen, MinimumOverwerken)
					values (1000, 1000, 1000, 1000, 1000, 0, 0)
				end

				delete from @tblTotalen
				insert into @tblTotalen SELECT top 1 huidigeTotalen.week, huidigeTotalen.maand, huidigeTotalen.drieMaand, huidigeTotalen.zesMaand, huidigeTotalen.jaar, huidigeTotalen.ongelimiteerd, huidigeTotalen.prestOvergenomen, huidigeTotalen.weekNeg, huidigeTotalen.maandNeg, huidigeTotalen.kwartNeg, huidigeTotalen.SemNeg, huidigeTotalen.jaarNeg FROM [time_tblOveruurMedewerkerTotaal] as huidigeTotalen where mdwID = @mdwID and tijdstempel < DATEADD(dd, 0, DATEDIFF(dd, 0, GETDATE())) order by tijdstempel desc 

				if cast((select count(*) from @tblTotalen) as int) = 0
				begin
					insert into @tblTotalen (iWeek, iMaand, iDrieMaand, iZesMaand, iJaar, iOngl, overgenomen, iWeekNeg, iMaandneg, iDrieMaandNeg, iZesMaandNeg, iJaarNeg)
					values (0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
					insert into [time_tblOveruurMedewerkerTotaal] (mdwID, week, maand, drieMaand, zesMaand, jaar, ongelimiteerd, lastEdited, tijdstempel, prestOvergenomen, weekNeg, maandNeg, kwartNeg, SemNeg, jaarNeg)
					values (@mdwID, 0, 0, 0, 0, 0, 0, GETDATE(), @startTijd, 0, 0, 0, 0, 0, 0)
				end

				--Indien nodig de totalen op 0 zetten
				declare @nieuweMaand bit = 0
				if datepart(dw, @startTijd) = 2
					update @tblTotalen set iWeek = 0, iWeekNeg = 0
				if DATEPART(D, @startTijd) = 1
				begin
					set @nieuweMaand = 1
					update @tblTotalen set iMaand = 0, iMaandneg = 0
					if (MONTH(@startTijd) % 3) = 1
						update @tblTotalen set iDrieMaand = 0, iDrieMaandNeg = 0
					else 
						update @tblTotalen set iDrieMaand = iDrieMaand - iDrieMaandNeg
					if (MONTH(@startTijd) % 6) = 1
						update @tblTotalen set iZesMaand = 0, iZesMaandNeg = 0
					else 
						update @tblTotalen set iZesMaand = iZesMaand - iZesMaandNeg
					if MONTH(@startTijd) = 1 and DATEPART(D, @startTijd) = 1
					begin
						update @tblTotalen set iJaar = 0, iJaarNeg = 0
						if cast((select overnemen from @tblRegel) as bit) = 1 
						begin
							update @tblTotalen set iOngl = cast((select ongelimiteerd from [time_tblOveruurMedewerkerTotaal] where mdwID = @mdwID and DATEPART(year, tijdstempel) = (DATEPART(year, @startTijd) - 1) and DATEPART(MONTH, tijdstempel) = 12) as bigint)
							if((select iOngl from @tblTotalen) is null)
								update @tblTotalen set iOngl = 0
						end
					end
					else
					begin
						update @tblTotalen set iJaar = iJaar - iJaarNeg, iOngl = iOngl - iJaarNeg
					end
				end

				if @situatieStat = 1
				begin
					if(select iDrieMaand from @tblTotalen) < 0
						update @tblTotalen set iDrieMaandNeg = iDrieMaand, iDrieMaand = 0
					if(select iZesMaand from @tblTotalen) < 0
						update @tblTotalen set iZesMaandNeg = iZesMaand, iZesMaand = 0
					if(select iJaar from @tblTotalen) < 0
						update @tblTotalen set iJaarNeg = iJaar, iJaar = 0, iOngl = 0
				end
				else
				begin
					declare @sitStatID int = cast((select top 1 timeConfigID from [time_tblOrgConfig] where orgID = @orgID and tijdstempel <= @datumTConfig and deactivated != 1 order by tijdstempel desc) as int)
					if (select top 1 situatieStatistieken from [time_tblOrgConfig] where orgID = @orgID and tijdstempel <= @datumTConfig and deactivated != 1 and timeConfigID != @sitStatID order by tijdstempel desc) = 1
						update @tblTotalen set iDrieMaand += iDrieMaandNeg, iZesMaand += iZesMaandNeg, iJaar += iJaarNeg, iOngl += iJaarNeg, iDrieMaandNeg = 0, iZesMaandNeg = 0, iJaarNeg = 0
				end

				--Controlleren of er overgenomen moet worden
				declare @nuOvergenomen bit = 0
				if cast((select overnemen from @tblRegel) as bit) = 1 and cast((select overgenomen from @tblTotalen) as bit) = 0
				begin
					declare @alOvergenomen bit = cast((SELECT count(*) FROM [time_tblOveruurMedewerkerTotaal] where mdwID = @mdwID and prestOvergenomen = 1) as bit)
					if @alOvergenomen = 0
					begin
						set @nuOvergenomen = 1
						declare @overTeNemen bigint = cast((SELECT top 1 ongelimiteerd FROM [time_tblOveruurMedewerkerTotaal] where mdwID = @mdwID and DATEPART(dd,tijdstempel) = 01 and DATEPART(yyyy,tijdstempel) = (DATEPART(yyyy,GETDATE()) - 1) order by tijdstempel desc) as bigint)
						if @overTeNemen is not null and @overTeNemen != ''
						begin
							update @tblTotalen set iOngl = (cast((select innerTbl.iOngl from @tblTotalen as innerTbl) as bigint) + @overTeNemen)
							update @tblTotalen set iJaar = (cast((select innerTbl.iJaar from @tblTotalen as innerTbl) as bigint) + @overTeNemen)
						end
					end
				end	

				--aantal gewerkte uren vergelijken met het aantal verwachte uren
				declare @teWerkenUren bigint = (cast((select SUBSTRING(aantalUur, 1, 2) from  [dbo].[getAantalUurPerDagVolgensUurrooster](@startTijd, @mdwID)) as bigint) * 36000000000) + (cast((select SUBSTRING(aantalUur, 4, 2) from  [dbo].[getAantalUurPerDagVolgensUurrooster](@datumGisteren, @mdwID)) as bigint) * 600000000)
				if @teWerkenUren is null
					set @teWerkenUren = 0

				--Nagaan of er verlof van toepassing is
				declare @buID int = (select top 1 BUID from [dbo].GethuidigeBuVanMdw(@mdwID, @startTijd))
				if not exists(select *  from (select * from [dbo].[prmPrestatiecodes] where orgID = @orgID and okcCode = 'R') as tblPrestatieCodes where buid = @buID)
					set @buID = 0

				if exists(select datum from [dbo].fn_getalleFeestdagen(@mdwID, @orgID, @buID, DATEPART(yy, @startTijd)) where datum = DATEADD(dd, 0, DATEDIFF(dd, 0, @startTijd)))
					set @teWerkenUren = 0

				if exists(select datum from [dbo].fn_getalleCollectieveVerlofdagen(@mdwID, @orgID, @buID, DATEPART(yy, @startTijd), @startTijd, @startTijd, 0) where datum = DATEADD(dd, 0, DATEDIFF(dd, 0, @startTijd)))
					set @teWerkenUren = @teWerkenUren - cast((select aantaluur from [dbo].fn_getalleCollectieveVerlofdagen(@mdwID, @orgID, @buID, DATEPART(yy, @startTijd), @startTijd, @startTijd, 0) where datum = @startTijd) as bigint) * 36000000000

				if exists(select datum from [dbo].fn_getalleVerlofdagenMdw(@mdwID, DATEPART(yy, @startTijd), 1) where datum = DATEADD(dd, 0, DATEDIFF(dd, 0, @startTijd)))
					set @teWerkenUren = @teWerkenUren - cast((select aantaluur from [dbo].fn_getalleVerlofdagenMdw(@mdwID, DATEPART(yy, @startTijd), 1) where datum = DATEADD(dd, 0, DATEDIFF(dd, 0, @startTijd))) as bigint) * 36000000000
				
				if(@teWerkenUren < 0)
					set @teWerkenUren = 0
				set @totSec = @totSec - @teWerkenUren
				if(@totSec * 60 < ((SELECT MinimumOverwerken FROM @tblRegel) * 36000000000))
					set @totSec = 0

				--De gewerkte tijd van vandaag afvlakken
				if @situatieStat = 3
				begin
					if (cast((select maxPerDag from @tblRegel) as bigint) * 36000000000) <= @totSec
						set @totSec = cast((select maxPerDag from @tblRegel) as bigint) * 36000000000

					if datepart(dw, @startTijd) = 1
					begin
						if (cast((select maxPerWeek from @tblRegel) as bigint) * 36000000000) < (cast((select iWeek from @tblTotalen) as bigint) + @totSec)
						begin
							update @tblTotalen set iWeek = cast((select maxPerWeek from @tblRegel) as int) * 36000000000 - @totSec--,
							--iMaand = iMaand - iWeek + cast((select maxPerWeek from @tblRegel) as int) * 36000000000 - @totSec,
							--iDrieMaand = iDrieMaand - iWeek + cast((select maxPerWeek from @tblRegel) as int) * 36000000000 - @totSec,
							--iZesMaand = iZesMaand - iWeek + cast((select maxPerWeek from @tblRegel) as int) * 36000000000 - @totSec,
							--iJaar = iJaar - iWeek + cast((select maxPerWeek from @tblRegel) as int) * 36000000000 - @totSec,
							--iOngl = iOngl - iWeek + cast((select maxPerWeek from @tblRegel) as int) * 36000000000 - @totSec
						end
					end
				
					declare @datumMorgen datetime = DATEADD(day, 1, @datumGisteren)
					if DATEPART(D, @datumMorgen) = 1
					begin
						if (cast((select maxPerMaand from @tblRegel) as bigint) * 36000000000) < (cast((select iMaand from @tblTotalen) as bigint) + @totSec)
						begin
							update @tblTotalen set iMaand = cast((select maxPerMaand from @tblRegel) as int) * 36000000000 - @totSec,
							iDrieMaand = iDrieMaand - iMaand + cast((select maxPerMaand from @tblRegel) as int) * 36000000000 - @totSec,
							iZesMaand = iZesMaand - iMaand + cast((select maxPerMaand from @tblRegel) as int) * 36000000000 - @totSec,
							iJaar = iJaar - iMaand + cast((select maxPerMaand from @tblRegel) as int) * 36000000000 - @totSec,
							iOngl = iOngl - iMaand + cast((select maxPerMaand from @tblRegel) as int) * 36000000000 - @totSec
						end

						if (MONTH(@datumMorgen) % 3) = 1
						begin
							if (cast((select maxPerDrieMaand from @tblRegel) as bigint) * 36000000000) < (cast((select iDrieMaand from @tblTotalen) as bigint) + @totSec)
							begin
								update @tblTotalen set iDrieMaand = cast((select maxPerDrieMaand from @tblRegel) as int) * 36000000000 - @totSec,
								iZesMaand = iZesMaand - iDrieMaand + cast((select maxPerDrieMaand from @tblRegel) as int) * 36000000000 - @totSec,
								iJaar = iJaar - iDrieMaand + cast((select maxPerDrieMaand from @tblRegel) as int) * 36000000000 - @totSec,
								iOngl = iOngl - iDrieMaand + cast((select maxPerDrieMaand from @tblRegel) as int) * 36000000000 - @totSec
							end
						end

						if (MONTH(@datumMorgen) % 6) = 1
						begin
							if (cast((select maxPerZesMaand from @tblRegel) as bigint) * 36000000000) < (cast((select iZesMaand from @tblTotalen) as bigint) + @totSec)
							begin
								update @tblTotalen set iZesMaand = cast((select maxPerZesMaand from @tblRegel) as int) * 36000000000 - @totSec,
								iJaar = iJaar - iZesMaand + cast((select maxPerZesMaand from @tblRegel) as int) * 36000000000 - @totSec,
								iOngl = iOngl - iZesMaand + cast((select maxPerZesMaand from @tblRegel) as int) * 36000000000 - @totSec
							end
						end

						if MONTH(@datumMorgen) = 1 and DATEPART(D, @datumMorgen) = 1
						begin
							if (cast((select maxPerJaar from @tblRegel) as bigint) * 36000000000) < (cast((select iJaar from @tblTotalen) as bigint) + @totSec) and (cast((select maxPerJaar from @tblRegel) as bigint) * 36000000000) < (cast((select iOngl from @tblTotalen) as bigint) + @totSec)
							begin
								update @tblTotalen set iJaar = cast((select maxPerJaar from @tblRegel) as int) * 36000000000 - @totSec,
								iOngl = iOngl - iJaar + cast((select maxPerJaar from @tblRegel) as int) * 36000000000 - @totSec
							end
						end
					end
				end

				if @situatieStat = 1 and @totSec < 0
				begin
					update @tblTotalen set iWeekNeg = iWeekNeg + @totSec,
					iMaandneg = iMaandneg + @totSec,
					iDrieMaandNeg = iDrieMaandNeg + @totSec,
					iZesMaandNeg = iZesMaandNeg + @totSec,
					iJaarNeg = iJaarNeg + @totSec
					set @totSec = 0
				end

				if @situatieStat = 1 and @totSec > 0
				begin
					--TOV dag
					if (cast((select maxPerDag from @tblRegel) as bigint) * 36000000000) <= @totSec
						set @totSec = cast((select maxPerDag from @tblRegel) as bigint) * 36000000000

					declare @waardeVoorAfvlakking bigint
					--TOV week
					if (cast((select maxPerWeek from @tblRegel) as bigint) * 36000000000) <= cast((select iWeek from @tblTotalen) as bigint)
					begin
						set @waardeVoorAfvlakking = (select iWeek from @tblTotalen)
						set @totSec = 0
						update @tblTotalen set iWeek = cast((select maxPerWeek from @tblRegel) as bigint) * 36000000000
						if  ((select iMaand from @tblTotalen) + (select iMaandneg from @tblTotalen)) > 0
							update @tblTotalen set iMaand = iMaand - @waardeVoorAfvlakking  + cast((select maxPerWeek from @tblRegel) as bigint) * 36000000000
						if  ((select iDrieMaand from @tblTotalen) + (select iDrieMaandNeg from @tblTotalen)) > 0
							update @tblTotalen set iDrieMaand = iDrieMaand - @waardeVoorAfvlakking + cast((select maxPerWeek from @tblRegel) as bigint) * 36000000000
						if  ((select iZesMaand from @tblTotalen) + (select iZesMaandNeg from @tblTotalen)) > 0
							update @tblTotalen set iZesMaand = iZesMaand - @waardeVoorAfvlakking + cast((select maxPerWeek from @tblRegel) as bigint) * 36000000000
						if  ((select iJaar from @tblTotalen) + (select iJaarNeg from @tblTotalen)) > 0
							update @tblTotalen set iJaar = iJaar - @waardeVoorAfvlakking + cast((select maxPerWeek from @tblRegel) as bigint) * 36000000000,
							iOngl = iOngl - @waardeVoorAfvlakking + cast((select maxPerWeek from @tblRegel) as bigint) * 36000000000
					end
					else
					begin
						if (cast((select maxPerWeek from @tblRegel) as bigint) * 36000000000) < cast((cast((select iWeek from @tblTotalen) as bigint) + @totSec) as bigint)
						begin
							set @totSec = (cast((select maxPerWeek from @tblRegel) as bigint) * 36000000000) - cast((select iWeek from @tblTotalen) as bigint)
						end
					end

					--TOV maand
					if (cast((select maxPerMaand from @tblRegel) as bigint) * 36000000000) < cast((select iMaand from @tblTotalen) as bigint) 
					begin
						set @waardeVoorAfvlakking = (select iMaand from @tblTotalen)
						set @totSec = 0
						if  ((select iMaand from @tblTotalen) + (select iMaandneg from @tblTotalen)) > 0
							update @tblTotalen set iMaand = cast((select maxPerMaand from @tblRegel) as bigint) * 36000000000
						if  ((select iDrieMaand from @tblTotalen) + (select iDrieMaandNeg from @tblTotalen)) > 0
							update @tblTotalen set iDrieMaand = iDrieMaand - @waardeVoorAfvlakking + cast((select maxPerMaand from @tblRegel) as bigint) * 36000000000
						if  ((select iZesMaand from @tblTotalen) + (select iZesMaandNeg from @tblTotalen)) > 0
							update @tblTotalen set iZesMaand = iZesMaand - @waardeVoorAfvlakking + cast((select maxPerMaand from @tblRegel) as bigint) * 36000000000
						if  ((select iJaar from @tblTotalen) + (select iJaarNeg from @tblTotalen)) > 0
							update @tblTotalen set iJaar = iJaar - @waardeVoorAfvlakking + cast((select maxPerMaand from @tblRegel) as bigint) * 36000000000,
							iOngl = iOngl - @waardeVoorAfvlakking + cast((select maxPerMaand from @tblRegel) as bigint) * 36000000000
					end
					else
					begin
						if (cast((select maxPerMaand from @tblRegel) as bigint) * 36000000000) < cast((cast((select iMaand from @tblTotalen) as bigint) + @totSec) as bigint)
						begin
							set @totSec = (cast((select maxPerMaand from @tblRegel) as bigint) * 36000000000) - cast((select iMaand from @tblTotalen) as bigint)
						end
					end
					
					--TOV drieMaand
					if (cast((select maxPerDrieMaand from @tblRegel) as bigint) * 36000000000) < cast((select iDrieMaand from @tblTotalen) as bigint)
					begin
						set @waardeVoorAfvlakking = (select iDrieMaand from @tblTotalen)
						set @totSec = 0
						if  ((select iDrieMaand from @tblTotalen) + (select iDrieMaandNeg from @tblTotalen)) > 0
							update @tblTotalen set iDrieMaand = cast((select maxPerDrieMaand from @tblRegel) as bigint) * 36000000000
						if  ((select iZesMaand from @tblTotalen) + (select iZesMaandNeg from @tblTotalen)) > 0
							update @tblTotalen set iZesMaand = iZesMaand - @waardeVoorAfvlakking + cast((select maxPerDrieMaand from @tblRegel) as bigint) * 36000000000
						if  ((select iJaar from @tblTotalen) + (select iJaarNeg from @tblTotalen)) > 0
							update @tblTotalen set iJaar = iJaar - @waardeVoorAfvlakking + cast((select maxPerDrieMaand from @tblRegel) as bigint) * 36000000000,
							iOngl = iOngl - @waardeVoorAfvlakking + cast((select maxPerDrieMaand from @tblRegel) as bigint) * 36000000000
					end
					else
					begin
						if (cast((select maxPerDrieMaand from @tblRegel) as bigint) * 36000000000) < cast((cast((select iDrieMaand from @tblTotalen) as bigint) + @totSec) as bigint)
						begin
							set @totSec = (cast((select maxPerDrieMaand from @tblRegel) as bigint) * 36000000000) - cast((select iDrieMaand from @tblTotalen) as bigint)
						end
					end

					--TOV zesMaand
					if (cast((select maxPerZesMaand from @tblRegel) as bigint) * 36000000000) < cast((select iZesMaand from @tblTotalen) as bigint)
					begin
						set @waardeVoorAfvlakking = (select iZesMaand from @tblTotalen)
						set @totSec = 0
						if  ((select iZesMaand from @tblTotalen) + (select iZesMaandNeg from @tblTotalen)) > 0
							update @tblTotalen set iZesMaand = cast((select maxPerZesMaand from @tblRegel) as bigint) * 36000000000
						if  ((select iJaar from @tblTotalen) + (select iJaarNeg from @tblTotalen)) > 0
							update @tblTotalen set iJaar = iJaar - @waardeVoorAfvlakking + cast((select maxPerZesMaand from @tblRegel) as bigint) * 36000000000,
							iOngl = iOngl - @waardeVoorAfvlakking + cast((select maxPerZesMaand from @tblRegel) as bigint) * 36000000000
					end
					else
					begin
						if (cast((select maxPerZesMaand from @tblRegel) as bigint) * 36000000000) < cast((cast((select iZesMaand from @tblTotalen) as bigint) + @totSec) as bigint)
						begin
							set @totSec = (cast((select maxPerZesMaand from @tblRegel) as bigint) * 36000000000) - cast((select iZesMaand from @tblTotalen) as bigint)
						end
					end

					--TOV jaar
					if (cast((select maxPerJaar from @tblRegel) as bigint) * 36000000000) < cast((select iJaar from @tblTotalen) as bigint)
					begin
						set @totSec = 0
						if  ((select iJaar from @tblTotalen) + (select iJaarNeg from @tblTotalen)) > 0
							update @tblTotalen set iJaar = cast((select maxPerJaar from @tblRegel) as bigint) * 36000000000  - (select iJaarNeg from @tblTotalen)
					end
					else
					begin
						if (cast((select maxPerJaar from @tblRegel) as bigint) * 36000000000) < cast((cast((select iJaar from @tblTotalen) as bigint) + @totSec) as bigint)
						begin
							set @totSec = (cast((select maxPerJaar from @tblRegel) as bigint) * 36000000000) - cast((select iJaar from @tblTotalen) as bigint)
						end
					end

					--TOV ongelimiteerd
					if cast((select overnemen from @tblRegel) as bit) = 1
					begin
						if (cast((select maxPerJaar from @tblRegel) as bigint) * 36000000000) < cast((select iOngl from @tblTotalen) as bigint)
						begin
							set @totSec = 0
							if  ((select iJaar from @tblTotalen) + (select iJaarNeg from @tblTotalen)) > 0
								update @tblTotalen set iOngl = cast((select maxPerJaar from @tblRegel) as bigint) * 36000000000
						end
						else
						begin
							if (cast((select maxPerJaar from @tblRegel) as bigint) * 36000000000) < cast((cast((select iOngl from @tblTotalen) as bigint) + @totSec) as bigint)
							begin
								set @totSec = (cast((select maxPerJaar from @tblRegel) as bigint) * 36000000000) - cast((select iOngl from @tblTotalen) as bigint)
							end
						end
					end
				end

				if @situatieStat = 1
				begin
					if datepart(dw, @startTijd) = 1
					begin
						update @tblTotalen set iWeek = iWeek - iWeekNeg,
						iWeekNeg = 0
					end

					declare @dteMorgen datetime = DATEADD(day, 1, @datumGisteren)
					if DATEPART(D, @dteMorgen) = 1
					begin
						update @tblTotalen set iMaand = iMaand + iMaandneg,
						iDrieMaand = iDrieMaand + iDrieMaandNeg,
						iZesMaand = iZesMaand + iZesMaandNeg,
						iJaar = iJaar + iJaarNeg, iOngl = iOngl + iJaarNeg
					end
				end

				if @situatieStat = 2
				begin
					--TOV dag
					if (cast((select maxPerDag from @tblRegel) as bigint) * 36000000000) <= @totSec
						set @totSec = cast((select maxPerDag from @tblRegel) as bigint) * 36000000000

					--TOV week
					if (cast((select maxPerWeek from @tblRegel) as bigint) * 36000000000) <= cast((select iWeek from @tblTotalen) as bigint)
					begin
						if @totSec > 0
							set @totSec = 0
						update @tblTotalen set iWeek = cast((select maxPerWeek from @tblRegel) as bigint) * 36000000000,
						iMaand = iMaand - iWeek  + cast((select maxPerWeek from @tblRegel) as bigint) * 36000000000,
						iDrieMaand = iDrieMaand - iWeek + cast((select maxPerWeek from @tblRegel) as bigint) * 36000000000,
						iZesMaand = iZesMaand - iWeek + cast((select maxPerWeek from @tblRegel) as bigint) * 36000000000,
						iJaar = iJaar - iWeek + cast((select maxPerWeek from @tblRegel) as bigint) * 36000000000,
						iOngl = iOngl - iWeek + cast((select maxPerWeek from @tblRegel) as bigint) * 36000000000
					end
					else
					begin
						if (cast((select maxPerWeek from @tblRegel) as bigint) * 36000000000) < cast((cast((select iWeek from @tblTotalen) as bigint) + @totSec) as bigint)
							set @totSec = (cast((select maxPerWeek from @tblRegel) as bigint) * 36000000000) - cast((select iWeek from @tblTotalen) as bigint)
					end

					--TOV maand
					if (cast((select maxPerMaand from @tblRegel) as bigint) * 36000000000) <= cast((select iMaand from @tblTotalen) as bigint)
					begin
						if @totSec > 0
							set @totSec = 0
						update @tblTotalen set iMaand = cast((select maxPerMaand from @tblRegel) as bigint) * 36000000000,
						iDrieMaand = iDrieMaand - iMaand + cast((select maxPerMaand from @tblRegel) as bigint) * 36000000000,
						iZesMaand = iZesMaand - iMaand + cast((select maxPerMaand from @tblRegel) as bigint) * 36000000000,
						iJaar = iJaar - iMaand + cast((select maxPerMaand from @tblRegel) as bigint) * 36000000000,
						iOngl = iOngl - iMaand + cast((select maxPerMaand from @tblRegel) as bigint) * 36000000000
					end
					else
					begin
						if (cast((select maxPerMaand from @tblRegel) as bigint) * 36000000000) < cast((cast((select iMaand from @tblTotalen) as bigint) + @totSec) as bigint)
							set @totSec = (cast((select maxPerMaand from @tblRegel) as bigint) * 36000000000) - cast((select iMaand from @tblTotalen) as bigint)
					end

					--TOV drieMaand
					if (cast((select maxPerDrieMaand from @tblRegel) as bigint) * 36000000000) <= cast((select iDrieMaand from @tblTotalen) as bigint)
					begin
						if @totSec > 0
							set @totSec = 0
						update @tblTotalen set iDrieMaand = cast((select maxPerDrieMaand from @tblRegel) as bigint) * 36000000000,
						iZesMaand = iZesMaand - iDrieMaand + cast((select maxPerDrieMaand from @tblRegel) as bigint) * 36000000000,
						iJaar = iJaar - iDrieMaand + cast((select maxPerDrieMaand from @tblRegel) as bigint) * 36000000000,
						iOngl = iOngl - iDrieMaand + cast((select maxPerDrieMaand from @tblRegel) as bigint) * 36000000000
					end
					else
					begin
						if (cast((select maxPerDrieMaand from @tblRegel) as bigint) * 36000000000) < cast((cast((select iDrieMaand from @tblTotalen) as bigint) + @totSec) as bigint)
							set @totSec = (cast((select maxPerMaand from @tblRegel) as bigint) * 36000000000) - cast((select iDrieMaand from @tblTotalen) as bigint)
					end

					--TOV zesMaand
					if (cast((select maxPerZesMaand from @tblRegel) as bigint) * 36000000000) <= cast((select iZesMaand from @tblTotalen) as bigint)
					begin
						if @totSec > 0
							set @totSec = 0
						update @tblTotalen set iZesMaand = cast((select maxPerZesMaand from @tblRegel) as bigint) * 36000000000,
						iJaar = iJaar - iZesMaand + cast((select maxPerZesMaand from @tblRegel) as bigint) * 36000000000,
						iOngl = iOngl - iZesMaand + cast((select maxPerZesMaand from @tblRegel) as bigint) * 36000000000
					end
					else
					begin
						if (cast((select maxPerZesMaand from @tblRegel) as bigint) * 36000000000) < cast((cast((select iZesMaand from @tblTotalen) as bigint) + @totSec) as bigint)
							set @totSec = (cast((select maxPerZesMaand from @tblRegel) as bigint) * 36000000000) - cast((select iZesMaand from @tblTotalen) as bigint)
					end

					--TOV jaar
					if (cast((select maxPerJaar from @tblRegel) as bigint) * 36000000000) <= cast((select iJaar from @tblTotalen) as bigint)
					begin
						if @totSec > 0
							set @totSec = 0
						update @tblTotalen set iJaar = cast((select maxPerJaar from @tblRegel) as bigint) * 36000000000
					end
					else
					begin
						if (cast((select maxPerJaar from @tblRegel) as bigint) * 36000000000) < cast((cast((select iJaar from @tblTotalen) as bigint) + @totSec) as bigint)
							set @totSec = (cast((select maxPerJaar from @tblRegel) as bigint) * 36000000000) - cast((select iJaar from @tblTotalen) as bigint)
					end

					--TOV ongelimiteerd
					if cast((select overnemen from @tblRegel) as bit) = 1
					begin
						if (cast((select maxPerJaar from @tblRegel) as bigint) * 36000000000) <= cast((select iOngl from @tblTotalen) as bigint)
						begin
							if @totSec > 0
								set @totSec = 0
							update @tblTotalen set iOngl = cast((select maxPerJaar from @tblRegel) as bigint) * 36000000000
						end
						else
						begin
							if (cast((select maxPerJaar from @tblRegel) as bigint) * 36000000000) < cast((cast((select iOngl from @tblTotalen) as bigint) + @totSec) as bigint)
								set @totSec = (cast((select maxPerJaar from @tblRegel) as bigint) * 36000000000) - cast((select iOngl from @tblTotalen) as bigint)
						end
					end
				end

				--De nieuwe totalen opslaan in de totaalRij
				declare @totaalID int
				if @nieuweMaand = 0
				begin
					set @totaalID = cast((SELECT top 1 overdrachtID FROM [time_tblOveruurMedewerkerTotaal] as huidigeTotalen where mdwID = @mdwID order by tijdstempel desc) as int)
					update tblTot
					set tblTot.week = (cast((select iWeek from @tblTotalen) as bigint) + @totSec),
					tblTot.maand = (cast((select iMaand from @tblTotalen) as bigint) + @totSec),
					tblTot.drieMaand = (cast((select iDrieMaand from @tblTotalen) as bigint) + @totSec),
					tblTot.zesMaand = (cast((select iZesMaand from @tblTotalen) as bigint) + @totSec),
					tblTot.jaar = (cast((select iJaar from @tblTotalen) as bigint) + @totSec),
					tblTot.ongelimiteerd = (cast((select iOngl from @tblTotalen) as bigint) + @totSec),
					tblTot.lastEdited = GETDATE(),
					tblTot.tijdstempel = GETDATE(),
					tblTot.prestOvergenomen = @nuOvergenomen,
					tblTot.weekNeg = (select iWeekNeg from @tblTotalen),
					tblTot.maandNeg = (select iMaandNeg from @tblTotalen),
					tblTot.kwartNeg = (select iDrieMaandNeg from @tblTotalen),
					tblTot.SemNeg = (select iZesMaandNeg from @tblTotalen),
					tblTot.jaarNeg = (select iJaarNeg from @tblTotalen)
					from [time_tblOveruurMedewerkerTotaal] tblTot where tblTot.overdrachtID = @totaalID
				end
				else
				begin
					if cast((SELECT count(*) FROM [time_tblOveruurMedewerkerTotaal] where mdwID = @mdwID and tijdstempel >= DATEADD(dd, 0, DATEDIFF(dd, 0, GETDATE()))) as int) = 1
					begin
						set @totaalID = cast((SELECT top 1 overdrachtID FROM [time_tblOveruurMedewerkerTotaal] where mdwID = @mdwID and tijdstempel > DATEADD(dd, 0, DATEDIFF(dd, 0, GETDATE())) order by tijdstempel desc) as int)
						update tblTot
						set tblTot.week = (cast((select iWeek from @tblTotalen) as bigint) + @totSec),
						tblTot.maand = (cast((select iMaand from @tblTotalen) as bigint) + @totSec),
						tblTot.drieMaand = (cast((select iDrieMaand from @tblTotalen) as bigint) + @totSec),
						tblTot.zesMaand = (cast((select iZesMaand from @tblTotalen) as bigint) + @totSec),
						tblTot.jaar = (cast((select iJaar from @tblTotalen) as bigint) + @totSec),
						tblTot.ongelimiteerd = (cast((select iOngl from @tblTotalen) as bigint) + @totSec),
						tblTot.lastEdited = GETDATE(),
						tblTot.tijdstempel = GETDATE(),
						tblTot.prestOvergenomen = @nuOvergenomen,
						tblTot.weekNeg = (select iWeekNeg from @tblTotalen),
						tblTot.maandNeg = (select iMaandNeg from @tblTotalen),
						tblTot.kwartNeg = (select iDrieMaandNeg from @tblTotalen),
						tblTot.SemNeg = (select iZesMaandNeg from @tblTotalen),
						tblTot.jaarNeg = (select iJaarNeg from @tblTotalen)
						from [time_tblOveruurMedewerkerTotaal] tblTot where tblTot.overdrachtID = @totaalID
					end
					else
					begin
						insert into [time_tblOveruurMedewerkerTotaal] (mdwID, week, maand, drieMaand, zesMaand, jaar, ongelimiteerd, lastEdited, tijdstempel, prestOvergenomen, weekNeg, maandNeg, kwartNeg, SemNeg, jaarNeg)
						values (@mdwID, (cast((select iWeek from @tblTotalen) as bigint) + @totSec), (cast((select iMaand from @tblTotalen) as bigint) + @totSec), (cast((select iDrieMaand from @tblTotalen) as bigint) + @totSec), (cast((select iZesMaand from @tblTotalen) as bigint) + @totSec), (cast((select iJaar from @tblTotalen) as bigint) + @totSec), (cast((select iOngl from @tblTotalen) as bigint) + @totSec), GETDATE(), getdate(), cast((select overgenomen from @tblTotalen) as bit), (select iWeekNeg from @tblTotalen),(select iMaandneg from @tblTotalen), (select iDrieMaandNeg from @tblTotalen), (select iZesMaandNeg from @tblTotalen), (select iJaarNeg from @tblTotalen))
					end
				end 
			end
		end

		--Overstappen naar de volgende mdw
		set @aantalMdws = @aantalMdws - 1
	end
END
